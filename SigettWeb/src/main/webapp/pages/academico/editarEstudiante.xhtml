<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xml:lang="es" lang="es">

    <body>

        <ui:composition template="./principal.xhtml">
            <ui:define name="title">#{msg['lbl.editar']} #{msg['lbl.estudiante']}</ui:define>
            <ui:define name="content">
                <p:messages id="msm" showDetail="true"/>
                <p:tabView id="tabViewDatosEstudiante">
                    <p:tab title="#{msg['lbl.datos']} #{msg['lbl.personales']}">
                        <h:panelGrid styleClass="panelgrid" rowClasses="rowpanelgrid" columnClasses="col-sm-3,col-sm-7,col-sm-1,col-sm-1" columns="4">
                            <f:facet name="header">
                                <p:graphicImage id="foto" cache="false" styleClass="img-thumbnail" height="100" width="100" value="/AppServlet?id=#{sessionEstudiante.estudiante.persona.id}&amp;entity=Persona"/>
                            </f:facet>
                            <h:outputLabel value="#{msg['lbl.ci']}:" for="numeroIdentificacion" />
                            <p:inputText  id="numeroIdentificacion"  value="#{sessionEstudiante.estudiante.persona.numeroIdentificacion}" title="#{msg['lbl.ci']}" required="true" requiredMessage="#{msg['lbl.ci']} #{msg['lbl.obligatorio']}.">
                                <p:ajax event="keyup" update="msmNumeroIdentificacion" />
                                <p:ajax event="change" update="@this,:contenido:msm"/>
                            </p:inputText>
                            <p:fragment autoUpdate="true">
                                <p:commandButton value="#{msg['lbl.sincronizar']}" update=":contenido:tabViewDatosEstudiante,:contenido:msm" onstart="PF('dlgLoading').show();" oncomplete="PF('dlgLoading').hide()" action="#{administrarEstudiantes.sgaWebServicesDatosEstudiante(sessionEstudiante.estudiante)}"/>
                            </p:fragment>
                            <p:message id="msmNumeroIdentificacion" display="icon" for="numeroIdentificacion"/>
                            <h:outputLabel  value="#{msg['lbl.nombres']}:" for="nombres" />
                            <p:inputText id="nombres" value="#{sessionEstudiante.estudiante.persona.nombres}" title="#{msg['lbl.nombres']}" required="true" requiredMessage="#{msg['lbl.nombres']} #{msg['lbl.obligatorio']}.">
                                <p:ajax event="keyup" update="msmNombres"/>
                                <p:ajax event="change" update="@this,:contenido:msm"/>
                            </p:inputText>
                            <h:inputHidden/>
                            <p:message id="msmNombres" display="icon" for="nombres"/>
                            <h:outputLabel  value="#{msg['lbl.apellidos']}:" for="apellidos" />
                            <p:inputText  id="apellidos" value="#{sessionEstudiante.estudiante.persona.apellidos}" title="#{msg['lbl.apellidos']}" required="true" requiredMessage="#{msg['lbl.apellidos']} #{msg['lbl.obligatorio']}.">
                                <p:ajax event="keyup" update="msmApellidos"/>
                                <p:ajax event="change" update="@this,:contenido:msm"/>
                            </p:inputText>
                            <h:inputHidden/>
                            <p:message id="msmApellidos" display="icon" for="apellidos"/>
                            <h:outputLabel value="#{msg['lbl.email']}:" for="email" />
                            <p:inputText placeholder="Email" id="email" value="#{sessionEstudiante.estudiante.persona.email}" title="#{msg['lbl.email']}" required="true" requiredMessage="#{msg['lbl.email']} #{msg['lbl.obligatorio']}.">
                                <p:ajax event="keyup" update="msmEmail"/>
                                <p:ajax event="change" update="@this,:contenido:msm"/>
                            </p:inputText>
                            <h:inputHidden/>
                            <p:message id="msmEmail" display="icon" for="email"/>
                            <h:outputLabel value="#{msg['lbl.fechaNacimiento']}:" for="fechaNacimiento" />
                            <p:calendar  id="fechaNacimiento"  yearRange="c-100:c+20" navigator="true" locale="es" pattern="dd/MM/yyyy" value="#{sessionEstudiante.estudiante.persona.fechaNacimiento}" title="#{msg['lbl.fechaNacimiento']}" required="true" requiredMessage="#{msg['lbl.fechaNacimiento']} #{msg['lbl.obligatorio']}.">
                                <p:ajax event="dateSelect" update="msmFechaNacimiento"/>
                                <p:ajax event="change" update="@this,:contenido:msm"/>
                            </p:calendar>
                            <h:inputHidden/>
                            <p:message id="msmFechaNacimiento" display="icon" for="fechaNacimiento"/>
                            <h:outputLabel value="#{msg['lbl.tipoDocId']}:" for="tipoDocumentoIdentificacionId" />
                            <p:selectOneMenu  id="tipoDocumentoIdentificacionId" value="#{administrarEstudiantes.tipoDocumento}" required="true" requiredMessage="#{msg['lbl.tipoDocId']} #{msg['lbl.obligatorio']}.">
                                <f:selectItems value="#{administrarEstudiantes.listadoTiposDocumentos()}"/>
                                <p:ajax event="change" update="msmTipoDoc"/>
                            </p:selectOneMenu>
                            <h:inputHidden/>
                            <p:message id="msmTipoDoc" for="tipoDocumentoIdentificacionId"/>
                            <h:outputLabel  value="#{msg['lbl.genero']}:" for="generoId" />
                            <p:selectOneMenu id="generoId" value="#{administrarEstudiantes.genero}" required="true" requiredMessage="#{msg['lbl.genero']} #{msg['lbl.obligatorio']}.">
                                <!-- TODO: update below reference to list of available items-->
                                <f:selectItems value="#{administrarEstudiantes.listadoGeneros()}"/>
                                <p:ajax event="change" update="msmGenero"/>
                            </p:selectOneMenu>
                            <h:inputHidden/>
                            <p:message id="msmGenero" for="generoId"/>
                            <h:outputLabel  value="#{msg['lbl.activo']} :" for="activo" />
                            <p:selectBooleanCheckbox id="activo" value="#{sessionEstudiante.estudiante.esActivo}"/>
                        </h:panelGrid>
                    </p:tab>
                    <p:tab id="tabFotos" title="#{msg['lbl.fotos']}" rendered="#{administrarEstudiantes.renderedFotos}">
                        <h:panelGrid columns="1">
                            <p:dataGrid  value="#{administrarFotos.buscarPorPersona(sessionEstudiante.estudiante.persona)}"
                                         id="dgFotos" var="foto" 
                                         paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} "
                                         emptyMessage="#{msg['lbl.table.empty']}.">

                                <p:graphicImage id="foto" cache="false" styleClass="img-thumbnail" height="100" width="100" value="/AppServlet?id=#{foto.id}&amp;entity=Foto"/>
                                <br/>
                                <h:panelGrid  styleClass="pnl-botones" columns="3">
                                    <p:commandButton icon="ui-icon-circle-plus" onstart="PF('dlgLoading').show();" oncomplete="PF('dlgLoading').hide()" rendered="#{administrarFotos.renderedSeleccionar(view.viewId)}"  onclick="if (!confirm('Â¿#{msg['lbl.confirmarSeleccionar']} #{msg['lbl.foto']}?'))
                                                return false;" action="#{administrarFotos.seleccionarFoto(foto,view.viewId)}" update="dgFotos,:contenido:msm,:contenido:tabViewDatosEstudiante:foto"/>
                                    <p:commandButton  onstart="PF('dlgLoading').show();" oncomplete="PF('dlgLoading').hide()" update=":form-data,:contenido:msm" rendered="#{administrarFotos.renderedEditar()}"  action="#{administrarFotos.editar(foto,view.viewId)}" icon="ui-icon-pencil"/>
                                    <p:commandButton rendered="#{administrarFotos.renderedRemover()}" update="dgFotos,:contenido:msm,:contenido:tabViewDatosEstudiante:foto" onclick="if (!confirm('Â¿#{msg['lbl.confirmarEliminar']} #{msg['lbl.foto']}?'))
                                                return false;" action="#{administrarFotos.removerFoto(foto,view.viewId)}" process="@this" onstart="PF('dlgLoading').show();" oncomplete="PF('dlgLoading').hide()" icon="ui-icon-trash"/>
                                </h:panelGrid>
                            </p:dataGrid>
                        </h:panelGrid>
                        <br/>
                        <h:panelGrid styleClass="pnl-botones">
                            <p:commandButton icon="ui-icon-newwin"  onstart="PF('dlgLoading').show();" oncomplete="PF('dlgLoading').hide()" value="#{msg['lbl.crear']}" update=":form-data" action="#{administrarFotos.crear(view.viewId)}"/>
                        </h:panelGrid>
                    </p:tab>
                    <p:tab title="#{msg['lbl.carreras']}">
                        <h:panelGrid columns="2">
                            <p:pickList id="carreras"  value="#{administrarEstudiantes.carrerasDualList}" var="items" itemLabel="#{items}" itemValue="#{items}" showSourceControls="true" showTargetControls="true" showCheckbox="true"
                                        showSourceFilter="true" showTargetFilter="true" filterMatchMode="contains"  >
                                <f:facet name="sourceCaption">#{msg['lbl.carreras']} #{msg['lbl.disponibles']}</f:facet>
                                <f:facet name="targetCaption">#{msg['lbl.carreras']} #{msg['lbl.seleccionadas']}</f:facet>
                                <p:ajax event="transfer" listener="#{administrarEstudiantes.transferEstudianteCarrera}"></p:ajax>
                            </p:pickList>
                        </h:panelGrid>
                    </p:tab>
                    <p:tab  title="#{msg['lbl.informacion']} #{msg['lbl.estudio']}" rendered="#{administrarEstudiantes.renderedInformacionEstudio}">
                        <p:dataGrid  value="#{administrarEstudiantes.buscarEstudianteCarreras(sessionEstudiante.estudiante)}"
                                     id="dgEstudianteCarreras" var="item" columns="1" rows="5" paginator="true" paginatorPosition="bottom"
                                     paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} "
                                     emptyMessage="#{msg['lbl.table.empty']}.">

                            <p:panel header="#{item.id}. #{item.carreraId.nombre}">
                                <h:panelGrid id="datosEstudianteCarrera" styleClass="panelgrid" rowClasses="rowpanelgrid" columnClasses="col-sm-3,col-sm-9" columns="2" >
                                    <h:outputLabel value="#{msg['lbl.estado']}:"/>
                                    <h:outputText value="#{item.estadoEstudianteCarrera.nombre}"/>
                                    <h:outputLabel value="#{msg['lbl.fechaIngreso']}:"/>
                                    <h:outputText value="#{administrarEstudiantesCarrera.obtenerPrimerMatricula(item).ofertaAcademica.fechaInicio}">
                                        <f:convertDateTime pattern="dd/MM/yyyy"/>
                                    </h:outputText>
                                    <h:outputLabel value="#{msg['lbl.ultimoModuloAprobado']}:"/>
                                    <h:outputText value="#{administrarEstudiantesCarrera.obtenerMatriculaUltima(item).numeroModuloMatriculado} #{administrarEstudiantesCarrera.obtenerMatriculaUltima(item).paralelo}"/>
                                    <h:outputLabel value="#{msg['lbl.fechaCulminaciÃ³n']}:"/>
                                    <h:outputText value="#{administrarEstudiantesCarrera.obtenerMatriculaUltima(item).ofertaAcademica.fechaFin}">
                                        <f:convertDateTime pattern="dd/MM/yyyy"/>
                                    </h:outputText>
                                    <h:outputLabel id="lbEsApto" rendered="#{administrarEstudiantesCarrera.renderedEsAptoAspirante}" value="#{msg['lbl.esApto']}:"/>
                                    <p:selectBooleanCheckbox id="esApto" rendered="#{administrarEstudiantesCarrera.renderedEsAptoAspirante}" value="#{item.aspirante.esApto}">
                                        <p:ajax onstart="PF('dlgLoading').show();" oncomplete="PF('dlgLoading').hide()" listener="#{administrarEstudiantesCarrera.esAptoEstudiante(item)}" update=":contenido:msm"/>
                                    </p:selectBooleanCheckbox>
                                </h:panelGrid>
                                <br/>
                                <p:overlayPanel appendToBody="true"  my="left-top" showEffect="blind" for="detalleMatriculas"  hideEffect="fade">
                                    <p:dataTable id="tblReporteMatriculas" value="#{administrarEstudiantesCarrera.listadoMatriculasEstudiante(item)}" var="rm" rows="5" paginator="true"
                                                 rowIndexVar="rowIx" rowKey="#{rm.matriculaId}" selection="#{rm}" selectionMode="single" rowStyleClass="#{empty rowIx or rowIx mod 2 ne 0 ? 'even-row' : 'odd-row'}" emptyMessage="#{msg['lbl.table.empty']}">
                                        <p:column>
                                            <f:facet name="header">
                                                <h:outputText value="#{msg['lbl.numero']} #{msg['lbl.matricula']}"/>
                                            </f:facet>
                                            <h:outputText value="#{rm.matriculaId}"/>
                                        </p:column>
                                        <p:column>
                                            <f:facet name="header">
                                                <h:outputText value="#{msg['lbl.modulo']}"/>
                                            </f:facet>
                                            <h:outputText value="#{rm.moduloMatriculado}"/>
                                        </p:column>
                                        <p:column>
                                            <f:facet name="header">
                                                <h:outputText value="#{msg['lbl.numero']} #{msg['lbl.modulo']}"/>
                                            </f:facet>
                                            <h:outputText value="#{rm.numeroModuloMatriculado}"/>
                                        </p:column>
                                        <p:column>
                                            <f:facet name="header">
                                                <h:outputText value="#{msg['lbl.paralelo']}"/>
                                            </f:facet>
                                            <h:outputText value="#{rm.paralelo}"/>
                                        </p:column>
                                        <p:column>
                                            <f:facet name="header">
                                                <h:outputText value="#{msg['lbl.nota']}"/>
                                            </f:facet>
                                            <h:outputText  value="#{rm.nota}">
                                                <f:convertNumber minFractionDigits="2"/>
                                            </h:outputText>
                                        </p:column>
                                        <p:column>
                                            <f:facet name="header">
                                                <h:outputText value="#{msg['lbl.periodoAcademico']}"/>
                                            </f:facet>
                                            <h:outputText value="#{administrarConfiguraciones.date(rm.ofertaAcademica.fechaInicio)}- #{administrarConfiguraciones.date(rm.ofertaAcademica.fechaFin)}"/>
                                        </p:column>
                                        <p:column>
                                            <f:facet name="header">
                                                <h:outputText value="#{msg['lbl.estado']}"/>
                                            </f:facet>
                                            <h:outputText value="#{rm.estadoMatriculaId.nombre}"/>
                                        </p:column>
                                    </p:dataTable>

                                </p:overlayPanel>
                                <h:panelGrid columns="3" styleClass="pnl-botones" >
                                    <p:commandButton  icon="ui-icon-info" value="#{msg['lbl.matriculas']}" id="detalleMatriculas"/>
                                    <p:commandButton onstart="PF('dlgLoading').show();" oncomplete="PF('dlgLoading').hide()" update="tblReporteMatriculas,:contenido:msm" value="#{msg['lbl.sincronizar']} SGA" action="#{administrarEstudiantesCarrera.sgaWebServicesEstudianteMatriculas(item,sessionUsuario.usuario)}" icon="ui-icon-refresh"/>
                                    <p:commandButton value="#{msg['lbl.comprobar']}" icon="ui-icon-comprobar" onstart="PF('dlgLoading').show();" oncomplete="PF('dlgLoading').hide()" update="datosEstudianteCarrera,esApto,:contenido:msm" action="#{administrarEstudiantesCarrera.compruebaEsAspiranteApto(item)}"/>
                                </h:panelGrid>
                            </p:panel>
                        </p:dataGrid>
                    </p:tab>
                </p:tabView>
                <br/>
                <h:panelGrid  styleClass="pnl-botones"  columns="3" >
                    <p:commandButton id="guardar" value="#{msg['lbl.grabar']}" onstart="PF('dlgLoading').show()" oncomplete="PF('dlgLoading').hide()" update=":contenido:msm,:contenido:tabViewDatosEstudiante" icon="ui-icon-disk"  action="#{administrarEstudiantes.grabar(sessionEstudiante.estudiante)}">
                        <f:param name="1" value="grabar" />
                    </p:commandButton>
                    <p:commandButton id="guardarEditar"  onstart="PF('dlgLoading').show();" oncomplete="PF('dlgLoading').hide()" value="#{msg['lbl.grabar']} #{msg['lbl.editar']}" update=":contenido:msm,:contenido:tabViewDatosEstudiante" icon="ui-icon-disk" action="#{administrarEstudiantes.grabar(sessionEstudiante.estudiante)}">
                        <f:param name="1" value="grabar-editar" />
                    </p:commandButton>
                    <p:commandButton id="guardarCrear" value="#{msg['lbl.grabar']} #{msg['lbl.y']} #{msg['lbl.agregar']} #{msg['lbl.otro']}" onstart="PF('dlgLoading').show();" oncomplete="PF('dlgLoading').hide()" update=":contenido:msm,:contenido:tabViewDatosEstudiante" icon="ui-icon-disk" action="#{administrarEstudiantes.grabar(sessionEstudiante.estudiante)}">
                        <f:param name="1" value="grabar-crear" />
                    </p:commandButton>
                </h:panelGrid>
            </ui:define>
            <ui:define name="data">
                <p:dialog id="dlgFoto" header="EDITAR FOTO" widgetVar="dlgFoto" modal="true">
                    <h:panelGrid columns="1" >
                        <p:fileUpload multiple="false" fileUploadListener="#{administrarFotos.handleFileUpload}"  
                                      update=":contenido:msm,:contenido:tabViewDatosEstudiante:dgFotos"  mode="advanced"  
                                      allowTypes="/(\.|\/)(gif|jpe?g|png)$/" sizeLimit="#{administrarConfiguraciones.tamanioPermitidoFotos}" invalidFileMessage="#{msg['lbl.invalidTypeFileMessage']}"
                                      invalidSizeMessage="#{msg['lbl.fileLimitMessage']}"
                                      cancelLabel="#{msg['lbl.cancelar']}"  label="#{msg['lbl.seleccionar']}" uploadLabel="#{msg['lbl.subir']}" >
                        </p:fileUpload>
                    </h:panelGrid>
                </p:dialog>
            </ui:define>
        </ui:composition>

    </body>
</html>
